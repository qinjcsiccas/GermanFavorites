<script>
    function triggerFeedback(el) {          
        el.classList.add('vibrate'); 
        setTimeout(() => {
            el.innerHTML = '<span class="loading-spin">‚è≥</span>'; 
            el.style.pointerEvents = 'none'; 
        }, 100);
    }

    function feelLucky() {
        if (navigator.vibrate) {
            navigator.vibrate([10, 30, 10]);            
        }            
        const btn = document.getElementById('randomBtn');
        const tips = [
            "Ê≠£Âú®‰∏∫ÊÇ®ÂØªÊâæÂæ∑ËØ≠ÁßòÂ¢É...",
            "Looking for German secrets...",
            "Deutsch-Gott w√§hlt aus...", 
            "ÁúãÁúã‰ªäÂ§©Â≠¶ÁÇπ‰ªÄ‰πàÂ•ΩÂë¢Ôºü",
            "Was lernen wir heute?", 
            "Âæ∑ËØ≠‰πãÁ•ûÊ≠£Âú®ÊåëÈÄâ...",
            "Selecting your destiny...",
            "Viel Gl√ºck heute!",
            "Ê≠£Âú®Âä†ËΩΩÊÉäÂñú...",
            "Surprise is loading...",
            "Eine √úberraschung kommt!",
            "Built with ‚ù§Ô∏è by Jincheng Qin.",
            "Jincheng Á•ù‰Ω†Âæ∑ËØ≠ËøõÊ≠•ÔºÅ",
            "Ready for the next challenge?",
            "Keep calm and learn German.",
            "Jincheng Ê≠£Âú®‰∏∫‰Ω†ÂêåÊ≠•‰∫ëÁ´ØËµÑÊ∫ê...",
            "Viel Spa√ü beim Lernen!"
        ];
        const randomTip = tips[Math.floor(Math.random() * tips.length)];
    
        btn.classList.add('dice-spin', 'dice-glow');
        
        showToast(randomTip);
    
        setTimeout(() => {
            window.location.href = '/random';
        }, 800);
    }
    
    function showToast(msg, icon = 'üé≤') {
        const toast = document.createElement('div');
        toast.className = "fixed top-1/2 left-1/2 -translate-x-1/2 -translate-y-1/2 bg-black/60 backdrop-blur-lg text-white text-lg font-bold px-10 py-6 rounded-3xl shadow-2xl z-[500] animate-in zoom-in duration-300 text-center whitespace-nowrap max-w-[90vw] border border-white/10";
        toast.innerHTML = `
                <div class="text-3xl mb-3">${icon}</div> 
                <div class="leading-relaxed">${msg}</div> 
            `;
        
        document.body.appendChild(toast);
        
        setTimeout(() => {
            toast.style.opacity = '0';
            toast.style.transition = 'opacity 0.5s ease';
            setTimeout(() => toast.remove(), 500);
        }, 2200);
    }

    function confirmDelete() {
        document.getElementById('delete_name').value = document.getElementById('edit_name').value;
        document.getElementById('delete_url').value = document.getElementById('edit_url').value;
        
        document.getElementById('customConfirmModal').style.display = 'flex';
    }
    
    function closeConfirm() {
        document.getElementById('customConfirmModal').style.display = 'none';
    }
    
    function executeDelete() {
        document.getElementById('deleteForm').submit();
    }

    function saveFoldStatus(id) {
        setTimeout(() => {
            const el = document.getElementById(id);
            const isOpen = el.hasAttribute('open');
            localStorage.setItem(id, isOpen ? 'open' : 'closed');
        }, 50);
    }
    
    function restoreFoldStatus() {
        const categories = document.querySelectorAll('details[id^="cat-"]');
        categories.forEach(cat => {
            const savedStatus = localStorage.getItem(cat.id);
            
            if (savedStatus === 'open') {
                cat.setAttribute('open', '');
            } else if (savedStatus === 'closed') {
                cat.removeAttribute('open');
            } else {
                cat.removeAttribute('open'); 
            }
        });
    }
              
    document.addEventListener('DOMContentLoaded', function() {
        initLearningStats();
        
        restoreFoldStatus();
        
        const statsEl = document.getElementById('content-stats');
        if (statsEl && statsEl.style.display !== 'none') {
            renderStats();
        }
    });

    function initLearningStats() {
        let stats = JSON.parse(localStorage.getItem('learning_stats'));
        if (!stats || typeof stats.totalLearningTime === 'undefined') {
            stats = {
                totalLearningTime: 0,
                streakDays: 0,
                lastVisitDate: '',
                todayLearningTime: 0,
                resourceStats: {},
                bestDay: '',
                totalResources: 0,
                currentSession: null
            };
            localStorage.setItem('learning_stats', JSON.stringify(stats));
        }
        return stats;
    }
    
    let learningTimer = null;
    
    function startLearning(name, url, note) {
        const stats = initLearningStats();
        const now = Date.now();
        
        if (stats.currentSession) {
            endLearning();
        }
        
        stats.currentSession = {
            name: name,
            url: url,
            note: note || '',
            startTime: now,
            startDate: new Date().toDateString()
        };
        
        const today = new Date().toDateString();
        if (stats.lastVisitDate !== today) {
            if (stats.lastVisitDate) {
                const yesterday = new Date();
                yesterday.setDate(yesterday.getDate() - 1);
                if (stats.lastVisitDate === yesterday.toDateString()) {
                    stats.streakDays += 1;
                } else {
                    stats.streakDays = 1;
                }
            } else {
                stats.streakDays = 1;
            }
            stats.lastVisitDate = today;
        }
        
        if (!stats.resourceStats[name]) {
            stats.resourceStats[name] = {
                learningTime: 0,
                lastVisit: '',
                name: name,
                url: url,
                note: note || ''
            };
        }
        
        localStorage.setItem('learning_stats', JSON.stringify(stats));
        
        learningTimer = setInterval(() => {
            if (stats.currentSession) {
                const elapsed = Math.floor((Date.now() - stats.currentSession.startTime) / 1000);
                updateLearningDisplay(elapsed);
            }
        }, 1000);
        
        if (document.getElementById('content-stats') && document.getElementById('content-stats').style.display !== 'none') {
            renderStats();
        }
    }
    
    function updateLearningDisplay(seconds) {
        const countEl = document.getElementById('today-count');
        if (countEl && seconds && !isNaN(seconds)) {
            const minutes = Math.floor(seconds / 60);
            if (minutes < 1) {
                countEl.textContent = Math.floor(seconds) + 'Áßí';
            } else if (minutes < 60) {
                countEl.textContent = minutes + 'ÂàÜ';
            } else {
                const hours = Math.floor(minutes / 60);
                const mins = minutes % 60;
                countEl.textContent = hours + 'Êó∂' + mins + 'ÂàÜ';
            }
        }
    }
    
    function endLearning() {
        const stats = initLearningStats();
        
        if (learningTimer) {
            clearInterval(learningTimer);
            learningTimer = null;
        }
        
        if (!stats.currentSession) return;
        
        const now = Date.now();
        const sessionDuration = Math.floor((now - stats.currentSession.startTime) / 1000);
        
        if (sessionDuration >= 5) {
            stats.totalLearningTime += sessionDuration;
            stats.todayLearningTime += sessionDuration;
            
            const resourceName = stats.currentSession.name;
            if (stats.resourceStats[resourceName]) {
                stats.resourceStats[resourceName].learningTime += sessionDuration;
                stats.resourceStats[resourceName].lastVisit = new Date().toLocaleString();
            }
            
            if (stats.todayLearningTime > (stats.bestDayTime || 0)) {
                stats.bestDayTime = stats.todayLearningTime;
                stats.bestDay = stats.currentSession.startDate;
            }
            
            stats.totalResources = Object.keys(stats.resourceStats).length;
        }
        
        stats.currentSession = null;
        localStorage.setItem('learning_stats', JSON.stringify(stats));
    }
    
    document.addEventListener('visibilitychange', function() {
        if (document.visibilityState === 'hidden') {
            endLearning();
        }
    });
    
    window.addEventListener('beforeunload', function() {
        endLearning();
    });
    
    function recordResourceVisit(name, url, note) {
        startLearning(name, url, note);
    }
    
    function formatTime(seconds) {
        if (!seconds || seconds <= 0 || isNaN(seconds)) return '0Áßí';
        if (seconds < 60) return Math.floor(seconds) + 'Áßí';
        if (seconds < 3600) return Math.floor(seconds / 60) + 'ÂàÜ';
        const hours = Math.floor(seconds / 3600);
        const mins = Math.floor((seconds % 3600) / 60);
        return hours + 'Êó∂' + mins + 'ÂàÜ';
    }
    
    function renderStats() {
        const stats = initLearningStats();
        const today = new Date();
        const todayStr = today.toDateString();
        
        document.getElementById('today-date').textContent = today.toLocaleDateString('zh-CN', { month: 'numeric', day: 'numeric' });
        
        const todayTime = stats.lastVisitDate === todayStr ? stats.todayLearningTime : 0;
        let target = getLearningTarget() * 60;
        if (!target || target <= 0) target = 300;
        const percent = target > 0 ? Math.min(Math.round((todayTime / target) * 100), 100) : 0;
        document.getElementById('today-target').textContent = Math.floor(target / 60);
        
        document.getElementById('today-count').textContent = todayTime > 0 ? formatTime(todayTime) : '0Áßí';
        document.getElementById('today-progress').style.width = percent + '%';
        document.getElementById('today-percent').textContent = percent + '%';
        
        document.getElementById('streak-days').textContent = stats.streakDays;
        
        const starCount = Math.floor(stats.streakDays / 7);
        const streakStars = document.getElementById('streak-stars');
        streakStars.innerHTML = '';
        for (let i = 0; i < Math.min(starCount, 5); i++) {
            streakStars.innerHTML += '<span class="text-amber-400 text-base">‚≠ê</span>';
        }
        if (starCount === 0) {
            streakStars.innerHTML = '<span class="text-gray-200 text-base">‚òÜ‚òÜ‚òÜ‚òÜ‚òÜ</span>';
        } else if (starCount < 5) {
            for (let i = starCount; i < 5; i++) {
                streakStars.innerHTML += '<span class="text-gray-200 text-base">‚òÜ</span>';
            }
        }

        const streakMsg = document.getElementById('streak-message');
        if (stats.streakDays === 0) {
            streakMsg.textContent = '‰ªäÂ§©ÂºÄÂßã‰Ω†ÁöÑÂ≠¶‰π†‰πãÊóÖÂêßÔºÅ';
        } else if (stats.streakDays < 3) {
            streakMsg.textContent = 'Â•ΩÁöÑÂºÄÂßãÔºåÁªßÁª≠ÂùöÊåÅÔºÅ';
        } else if (stats.streakDays < 7) {
            streakMsg.textContent = '‰Ω†Â∑≤ÁªèÂùöÊåÅ‰∫Ü ' + stats.streakDays + ' Â§©ÔºåÂä†Ê≤πÔºÅ';
        } else if (stats.streakDays < 30) {
            streakMsg.textContent = 'üåü ÊòüËΩ®ÂàùÁé∞Ôºå‰Ω†Â∑≤ÁªèÂùöÊåÅ‰∫Ü ' + stats.streakDays + ' Â§©';
        } else {
            streakMsg.textContent = 'üå† ‰Ω†ÊòØÁúüÊ≠£ÁöÑÂæ∑ËØ≠‰πãÊòüÔºÅËøûÁª≠Â≠¶‰π† ' + stats.streakDays + ' Â§©';
        }
        
        document.getElementById('total-visits').textContent = formatTime(stats.totalLearningTime);
        document.getElementById('total-resources').textContent = stats.totalResources;
        document.getElementById('best-day').textContent = stats.bestDay ? new Date(stats.bestDay).toLocaleDateString('zh-CN', { month: 'numeric', day: 'numeric' }) : '‰ªäÊó•';
        
        renderTopResources(stats);
    }

    function getLearningTarget() {
        let target = localStorage.getItem('daily_target');
        if (!target) {
            target = 5;
            localStorage.setItem('daily_target', target);
        }
        return parseInt(target);
    }
    
    function showTargetSetting() {
        const currentTarget = getLearningTarget();
        document.getElementById('targetValue').textContent = currentTarget;
        document.getElementById('targetModal').style.display = 'flex';
    }
    
    function adjustTarget(delta) {
        const targetElement = document.getElementById('targetValue');
        let current = parseInt(targetElement.textContent);
        let newValue = current + delta;
        if (newValue >= 1 && newValue <= 50) {
            targetElement.textContent = newValue;
        }
    }
    
    function saveTarget() {
        const newTarget = parseInt(document.getElementById('targetValue').textContent);
        localStorage.setItem('daily_target', newTarget);
        document.getElementById('targetModal').style.display = 'none';
        
        const statsEl = document.getElementById('content-stats');
        if (statsEl && statsEl.style.display !== 'none') {
            renderStats();
        }
        
        showToast(`ÊØèÊó•ÁõÆÊ†áÂ∑≤ËÆæ‰∏∫ ${newTarget} ÂàÜÈíü`, 'üéØ');
    }
    
    function renderTopResources(stats) {
        const resourceList = document.getElementById('top-resources-list');
        
        const resources = Object.values(stats.resourceStats)
            .sort((a, b) => b.learningTime - a.learningTime)
            .slice(0, 10);
        
        if (resources.length === 0) {
            resourceList.innerHTML = `
                <div class="text-center py-8 text-gray-300 text-sm">
                    <div class="text-3xl mb-2">üåå</div>
                    <div>ÊöÇÊó†Â≠¶‰π†ËÆ∞ÂΩï</div>
                    <div class="text-xs mt-1">ÁÇπÂáªËµÑÊ∫êÂºÄÂßãËÆ∞ÂΩï‰Ω†ÁöÑÊòüËΩ®</div>
                </div>
            `;
            return;
        }
        
        const totalTime = stats.totalLearningTime;
        
        let html = '';
        resources.forEach((item, index) => {
            const percent = totalTime > 0 ? Math.round((item.learningTime / totalTime) * 100) : 0;
            const rankClass = index < 3 ? 'text-amber-500' : 'text-gray-400';
            const medal = index === 0 ? 'ü•á' : index === 1 ? 'ü•à' : index === 2 ? 'ü•â' : '';
            
            html += `
                <div class="flex items-center gap-2 hover:bg-gray-50 p-1 rounded-lg transition-colors">
                    <span class="w-5 text-xs font-bold ${rankClass}">${medal || index + 1}</span>
                    <div class="flex-1 min-w-0">
                        <a href="${item.url}" target="_blank" onclick="recordHistory('${item.name}', '${item.url}', '${item.note}')" class="block">
                            <div class="font-medium text-gray-800 text-base no-wrap">${item.name}</div>
                            <div class="text-xs text-gray-400 no-wrap">${item.note || 'Âæ∑ËØ≠Â≠¶‰π†ËµÑÊ∫ê'}</div>
                        </a>
                    </div>
                    <div class="text-right ml-2">
                        <div class="text-sm font-bold text-blue-600">${formatTime(item.learningTime)}</div>
                        <div class="text-xs text-gray-400">${percent}%</div>
                    </div>
                    <div class="w-12 h-1.5 bg-gray-100 rounded-full ml-1">
                        <div class="h-full bg-blue-500 rounded-full" style="width: ${percent}%"></div>
                    </div>
                </div>
            `;
        });
        
        resourceList.innerHTML = html;
    }
</script>
            
{% with messages = get_flashed_messages() %}
  {% if messages %}
    <script>
    document.addEventListener('DOMContentLoaded', function() {
        {% with messages = get_flashed_messages() %}
            {% for message in messages %}
                if (typeof showToast === 'function') {
                    let icon = "{{ message }}".includes("Âà†Èô§") ? "üóëÔ∏è" : "‚ú®";
                    showToast("{{ message }}", icon);
                }
            {% endfor %}
        {% endwith %}
    
        const savedScrollPos = localStorage.getItem('last_scroll_pos');
        if (savedScrollPos) {
            const targetPos = parseInt(savedScrollPos);
            
            if ('scrollRestoration' in history) {
                history.scrollRestoration = 'manual';
            }
    
            window.scrollTo(0, targetPos);
    
            setTimeout(() => {
                window.scrollTo({
                    top: targetPos,
                    behavior: 'auto'
                });
                localStorage.removeItem('last_scroll_pos');
            }, 50);
        }
    });
    </script>
  {% endif %}
{% endwith %}

<script>
    if (!window.hasExecutedFlashScroll) {
        document.addEventListener('DOMContentLoaded', function() {
            const savedScrollPos = localStorage.getItem('last_scroll_pos');
            if (savedScrollPos) {
                setTimeout(() => {
                    window.scrollTo({ top: parseInt(savedScrollPos), behavior: 'auto' });
                    localStorage.removeItem('last_scroll_pos');
                }, 100);
            }
        });
    }
</script>
